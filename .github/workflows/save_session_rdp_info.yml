name: Save RDP Connection Info

on:
  workflow_dispatch:
    inputs:
      rdp_url:
        description: 'URL complÃ¨te RDP (ex: tcp://2.tcp.ngrok.io:13427)'
        required: true
        type: string
      rdp_host:
        description: 'HÃ´te RDP (ex: 2.tcp.ngrok.io:13427)'
        required: true
        type: string
      rdp_user:
        description: 'Nom d\'utilisateur RDP'
        required: true
        type: string
        default: 'rdpuser'
      rdp_password:
        description: 'Mot de passe RDP'
        required: true
        type: string
        default: 'RDP123!'
      file_name:
        description: 'Nom du fichier Ã  crÃ©er/mettre Ã  jour'
        required: false
        type: string
        default: 'rdp_connection_info.txt'

jobs:
  save-rdp-info:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_TOKEN }}
        
    - name: Create RDP info file
      run: |
        # CrÃ©er le dossier s'il n'existe pas
        mkdir -p rdp_connections
        
        # CrÃ©er le fichier avec les informations RDP
        cat > "rdp_connections/${{ inputs.file_name }}" << EOF
        ================================================
        ðŸŽ¯ INFORMATIONS DE CONNEXION RDP
        ================================================
        ðŸ”— URL complÃ¨te: ${{ inputs.rdp_url }}
        ðŸŒ HÃ´te: ${{ inputs.rdp_host }}
        ðŸ‘¤ Utilisateur: ${{ inputs.rdp_user }}
        ðŸ”‘ Mot de passe: ${{ inputs.rdp_password }}
        ================================================
        ðŸ“… CrÃ©Ã© le: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        ðŸ“ SauvegardÃ© par: GitHub Actions
        ================================================
        EOF
        
        # Afficher le contenu pour vÃ©rification (masquer le mot de passe)
        echo "Contenu du fichier crÃ©Ã©:"
        sed 's/Mot de passe: .*/Mot de passe: [MASQUÃ‰]/' "rdp_connections/${{ inputs.file_name }}"
        
    - name: Create JSON format file
      run: |
        # CrÃ©er aussi une version JSON pour faciliter l'utilisation programmatique
        cat > "rdp_connections/${{ inputs.file_name }}.json" << EOF
        {
          "rdp_connection": {
            "url": "${{ inputs.rdp_url }}",
            "host": "${{ inputs.rdp_host }}",
            "username": "${{ inputs.rdp_user }}",
            "password": "${{ inputs.rdp_password }}",
            "created_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "created_by": "github-actions"
          }
        }
        EOF
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Ajouter les fichiers
        git add rdp_connections/
        
        # VÃ©rifier s'il y a des changements
        if git diff --staged --quiet; then
          echo "Aucun changement dÃ©tectÃ©, rien Ã  commit"
        else
          git commit -m "ðŸ–¥ï¸ Mise Ã  jour des informations de connexion RDP - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          git push
          echo "âœ… Informations RDP sauvegardÃ©es avec succÃ¨s!"
        fi
        
    - name: Create summary
      run: |
        echo "## ðŸŽ¯ RÃ©sumÃ© de la sauvegarde RDP" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Informations sauvegardÃ©es:" >> $GITHUB_STEP_SUMMARY
        echo "- **URL**: ${{ inputs.rdp_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- **HÃ´te**: ${{ inputs.rdp_host }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Utilisateur**: ${{ inputs.rdp_user }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Fichier**: rdp_connections/${{ inputs.file_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Fichiers crÃ©Ã©s:" >> $GITHUB_STEP_SUMMARY
        echo "- \`rdp_connections/${{ inputs.file_name }}\` (format texte)" >> $GITHUB_STEP_SUMMARY
        echo "- \`rdp_connections/${{ inputs.file_name }}.json\` (format JSON)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Sauvegarde terminÃ©e avec succÃ¨s!**" >> $GITHUB_STEP_SUMMARY
